{% extends "produkty/base.html" %}
{% load static %}
{% load produkty_tags %}

{% block title %}Lista Produktów{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Lista Produktów</h2>

    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-3">
                <input type="text" name="model" class="form-control" placeholder="Filtruj po modelu" value="{{ model_filter }}">
            </div>
            <div class="col-md-3">
                <input type="text" name="marka" class="form-control" placeholder="Filtruj po marce" value="{{ marka_filter }}">
            </div>
            <div class="col-md-2">
                <input type="text" name="grupa_towarowa" class="form-control" placeholder="Filtruj po grupie" value="{{ grupa_towarowa_filter }}">
            </div>
            <div class="col-md-1">
                <input type="number" step="0.01" name="prowizja_od" class="form-control" placeholder="Od" value="{{ prowizja_od }}">
            </div>
            <div class="col-md-1">
                <input type="number" step="0.01" name="prowizja_do" class="form-control" placeholder="Do" value="{{ prowizja_do }}">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Filtruj</button>
            </div>
        </div>
    </form>

    <div class="mb-4">
        <a href="?{% query_transform group='marka' %}" class="btn btn-secondary">Grupuj po marce</a>
        <a href="?{% query_transform group='grupa_towarowa' %}" class="btn btn-secondary">Grupuj po grupie produktowej</a>
        <a href="?{% query_transform group='' %}" class="btn btn-info">Pokaż wszystko</a>
    </div>

    {% if grouped_produkty %}
        <div class="accordion" id="groupedProduktyAccordion">
            {% for group_name, product_list in grouped_produkty.items %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ forloop.counter }}" aria-expanded="true" aria-controls="collapse-{{ forloop.counter }}">
                            {{ group_name }} ({{ product_list|length }})
                        </button>
                    </h2>
                    <div id="collapse-{{ forloop.counter }}" class="accordion-collapse collapse show" aria-labelledby="heading-{{ forloop.counter }}" data-bs-parent="#groupedProduktyAccordion">
                        <div class="accordion-body">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Model</th>
                                        <th>Marka</th>
                                        <th>Grupa towarowa</th>
                                        <th>Prowizja (Stawka)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for produkt in product_list %}
                                    <tr>
                                        <td>{{ produkt.model }}</td>
                                        <td>{{ produkt.marka }}</td>
                                        <td>{{ produkt.grupa_towarowa }}</td>
                                        <td>{{ produkt.stawka }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th><a href="?sort=model&dir={% if sort == 'model' and dir == 'asc' %}desc{% else %}asc{% endif %}&model={{ model_filter }}&marka={{ marka_filter }}&grupa_towarowa={{ grupa_towarowa_filter }}&prowizja_od={{ prowizja_od }}&prowizja_do={{ prowizja_do }}">Model</a></th>
                    <th><a href="?sort=marka&dir={% if sort == 'marka' and dir == 'asc' %}desc{% else %}asc{% endif %}&model={{ model_filter }}&marka={{ marka_filter }}&grupa_towarowa={{ grupa_towarowa_filter }}&prowizja_od={{ prowizja_od }}&prowizja_do={{ prowizja_do }}">Marka</a></th>
                    <th><a href="?sort=grupa_towarowa&dir={% if sort == 'grupa_towarowa' and dir == 'asc' %}desc{% else %}asc{% endif %}&model={{ model_filter }}&marka={{ marka_filter }}&grupa_towarowa={{ grupa_towarowa_filter }}&prowizja_od={{ prowizja_od }}&prowizja_do={{ prowizja_do }}">Grupa towarowa</a></th>
                    <th><a href="?sort=stawka&dir={% if sort == 'stawka' and dir == 'asc' %}desc{% else %}asc{% endif %}&model={{ model_filter }}&marka={{ marka_filter }}&grupa_towarowa={{ grupa_towarowa_filter }}&prowizja_od={{ prowizja_od }}&prowizja_do={{ prowizja_do }}">Prowizja (Stawka)</a></th>
                </tr>
            </thead>
            <tbody>
                {% for produkt in produkty %}
                <tr>
                    <td>{{ produkt.model }}</td>
                    <td>{{ produkt.marka }}</td>
                    <td>{{ produkt.grupa_towarowa }}</td>
                    <td>{{ produkt.stawka }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center">Brak produktów spełniających kryteria.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'produkty/js/lista_produktow.js' %}"></script>
{% endblock %}
